### âš™ï¸ `003_feature_normalization_priors.md`

# âš™ï¸ Ticket 003 â€“ Feature Normalization + Priors Integration

**Date:** 2025-11-15
**Owner:** Data / Modelling
**Status:** âœ… Complete
**Goal:** Convert cleaned migraine feature tables into normalized numerical encodings and attach literature-based prior distributions for simulator use.

---

## ğŸ¯ Objective

Implement deterministic feature normalization and attach population priors (Âµ, Ïƒ) for all biometric, environmental, and lifestyle variables.
This enables consistent data generation and scoring before simulator or ALINE pretraining.

---

## ğŸ“‚ Inputs

| File                                   | Description                         |
| -------------------------------------- | ----------------------------------- |
| `data/migraine_features_augmented.csv` | Parsed & bin-augmented feature list |
| `data/priors.yaml`                     | Âµ/Ïƒ priors + distribution families  |
| `scripts/normalize_features.py`        | Core normalization script           |
| `notebooks/feature_validation.ipynb`   | QA visualization                    |

---

## ğŸ§© Tasks

### 1. Load and Validate Augmented Feature Table

```python
import pandas as pd
feat = pd.read_csv("data/migraine_features_augmented.csv")
```

Confirm:

* Columns â†’ `category, variable, Typical Range, Migraine Impact Pattern, bin_edges, bin_centers, Weight`
* 51 total variables across 7 categories.

---

### 2. Attach Priors from Literature

`priors.yaml` example:

```yaml
HRV:
  dist: lognormal
  mu_ln: 3.5
  sigma_ln: 0.5
Resting Heart Rate:
  dist: normal
  mu: 65
  sigma: 10
Sleep Duration:
  dist: normal
  mu: 7.2
  sigma: 1.1
Barometric Pressure:
  dist: normal
  mu: 1013
  sigma: 12
Caffeine Intake:
  dist: piecewise
  params:
    threshold: 100
    low_slope: 0.01
    high_slope: 0.03
```

---

### 3. Build Feature Normalizer

```python
import bisect, json, numpy as np

def make_scorer(row):
    edges = json.loads(row["bin_edges"])
    pattern = [int(x) for x in str(row["Migraine Impact Pattern"]).split(",")]
    def score(x):
        i = min(9, max(0, bisect.bisect_right(edges, x)-1))
        return pattern[i]
    return score
```

Output normalized value âˆˆ [1, 10] with mean â‰ˆ 5.5 for typical range.

---

### 4. Generate Risk Weight Vector

Compute normalized scores and derive latent variables:
`Z = W_feat_to_Z @ s`,
where *s* is standardized feature vector and *W_feat_to_Z* defines latent stress/sleep/env/hormonal axes.

---

### 5. Save Priors and Normalizer

```python
import pickle
with open("data/feature_normalizer.pkl","wb") as f:
    pickle.dump({"priors":priors, "scorers":scorers}, f)
```

---

## ğŸ§  Integration with ALINE

* Supplies input distributions to **Ticket 004** (Simulator).
* Used for pretraining ALINEâ€™s inference head (`p(x|Î¸)` sampling).
* Forms the **population-level prior** for per-user personalization later (federated fine-tuning).

---

## âœ… Deliverables

* [x] `priors.yaml` (all 20 variables).
* [x] `scripts/normalize_features.py`.
* [x] `data/feature_normalizer.pkl`.
* [x] QA notebook visualizing impact patterns.

---

> *â€œNormalize the world before you learn from it.â€*

---