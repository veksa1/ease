### âš¡ `010_fastapi_service_endpoints.md`

# âš¡ Ticket 010 â€“ FastAPI Service for Risk + Posterior + Policy

**Date:** 2025-11-15
**Owner:** Backend / ML
**Status:** ğŸ”§ To Do
**Goal:** Expose endpoints that the UI calls to visualize distributions and daily risk. Integrate your predefined JSON schema.

---

## ğŸ¯ Objective

Implement FastAPI with GPU-aware inference loading:

* `/health` â€“ liveness/readiness
* `/risk/daily` â€“ daily rolling risk curve (returns (\hat{p}_D) and bands)
* `/posterior/hourly` â€“ per-hour posterior ( \mu_Z, \Sigma_Z ) for last 24 h
* `/policy/topk` â€“ suggested hours (indices 0â€“23) to sample/prompt next

---

## ğŸ“‚ Inputs

| File                       | Description                                     |
| -------------------------- | ----------------------------------------------- |
| `service/main.py`          | FastAPI app                                     |
| `service/schemas.py`       | Pydantic models (align with your JSON contract) |
| `runs/checkpoints/best.pt` | Model weights                                   |
| `configs/service.yaml`     | Model path, device, k                           |

---

## ğŸ§© Tasks

### 1) Boot & Device

* Autodetect CUDA; fallback CPU.
* Single global model instance with thread-safe inference.

### 2) Endpoints (sketch)

```python
# service/main.py
from fastapi import FastAPI
from .schemas import DailyRiskRequest, DailyRiskResponse, PosteriorResponse, PolicyRequest, PolicyResponse

app = FastAPI()

@app.get("/health")
def health(): return {"status": "ok"}

@app.post("/risk/daily", response_model=DailyRiskResponse)
def risk_daily(req: DailyRiskRequest): ...

@app.post("/posterior/hourly", response_model=PosteriorResponse)
def posterior_hourly(req): ...

@app.post("/policy/topk", response_model=PolicyResponse)
def policy_topk(req: PolicyRequest): ...
```

### 3) JSON Contract

* Match your predefined schema (ids, timestamps, units).
* Return arrays sized to 24 for daily windows; include uncertainty bands (e.g., 5th/95th percentiles).

### 4) Packaging

* Uvicorn runner + Dockerfile stage for service.
* Health/readiness for deployment.

---

## ğŸ§  Integration

* Consumed directly by the UI team.
* Uses Ticket 007 scoring + Ticket 008 rolling risk logic.

---

## âœ… Deliverables

* [ ] `service/` package with endpoints + schemas
* [ ] `Dockerfile.service` and run instructions
* [ ] Example `curl`/`httpie` scripts and sample JSONs in `examples/`

---

> *â€œAPIs are how models meet people.â€*

---
